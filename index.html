<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduQuiz - Mentoring Assessment System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--secondary);
        }

        h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--gray);
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #2a9dc4;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #d1145a;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #e4850c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: var(--light);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .timer.warning {
            color: var(--warning);
        }

        .timer.danger {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .question-card {
            display: none;
        }

        .question-card.active {
            display: block;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .option:hover {
            background-color: #f8f9fa;
            border-color: var(--primary);
        }

        .option.selected {
            background-color: rgba(67, 97, 238, 0.1);
            border-color: var(--primary);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .hidden {
            display: none;
        }

        .success-page {
            text-align: center;
            padding: 50px 20px;
        }

        .success-icon {
            font-size: 5rem;
            color: var(--success);
            margin-bottom: 20px;
        }

        .admin-login {
            max-width: 500px;
            margin: 50px auto;
        }

        .password-toggle {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-graded {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-filter input, .search-filter select {
            flex: 1;
        }

        .student-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .grading-area {
            margin-bottom: 30px;
        }

        .written-answer {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }

        .score-input {
            width: 80px;
        }

        .final-score {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 20px 0;
            color: var(--primary);
        }

        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .error-message {
            color: var(--danger);
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }

        .success-message {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .search-filter {
                flex-direction: column;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Confetti container for success page -->
    <div class="confetti-container" id="confettiContainer"></div>

    <!-- Student Homepage -->
    <div id="studentHomepage" class="page">
        <header>
            <div class="container">
                <h1>EduQuiz - Mentoring Assessment</h1>
                <p>Welcome to the Student Mentor Evaluation System</p>
            </div>
        </header>

        <div class="container">
            <div class="card">
                <h2>Student Registration</h2>
                <p>Please complete the registration form below to begin the mentoring assessment quiz.</p>
                
                <form id="registrationForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fullName">Full Name</label>
                            <input type="text" id="fullName" required>
                        </div>
                        <div class="form-group">
                            <label for="studentNumber">Student Number</label>
                            <input type="text" id="studentNumber" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="faculty">Faculty</label>
                        <select id="faculty" required>
                            <option value="">Select your faculty</option>
                            <option value="Education">Education</option>
                            <option value="Natural and Applied Science (NAS)">Natural and Applied Science (NAS)</option>
                            <option value="Humanities">Humanities</option>
                            <option value="Economic and Management Science (EMS)">Economic and Management Science (EMS)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn">Start Quiz</button>
                </form>
                
                <div class="admin-access" style="margin-top: 30px; text-align: center;">
                    <p>Are you an administrator?</p>
                    <a href="#" class="btn btn-secondary" id="adminAccessBtn">Admin Access</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Page -->
    <div id="quizPage" class="page hidden">
        <header>
            <div class="container">
                <h1>Mentoring Assessment Quiz</h1>
                <div class="timer" id="quizTimer">45:00</div>
            </div>
        </header>

        <div class="container">
            <div class="card">
                <div class="student-info">
                    <p><strong>Student:</strong> <span id="quizStudentName"></span> | <strong>Faculty:</strong> <span id="quizFaculty"></span></p>
                </div>
                
                <div class="progress-bar">
                    <div class="progress" id="quizProgress" style="width: 0%"></div>
                </div>
                
                <div id="questionContainer">
                    <!-- Questions will be dynamically inserted here -->
                </div>
                
                <div class="navigation">
                    <button class="btn btn-secondary" id="prevQuestion">Previous</button>
                    <button class="btn" id="nextQuestion">Next</button>
                    <button class="btn btn-success" id="submitQuiz" style="display: none;">Submit Quiz</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Page -->
    <div id="successPage" class="page hidden">
        <div class="container">
            <div class="success-page card">
                <div class="success-icon">🎉</div>
                <h2>Quiz Submitted Successfully!</h2>
                <p>Thank you for completing the mentoring assessment quiz.</p>
                
                <div class="score-display">
                    <h3>Your Results</h3>
                    <p>Multiple Choice Score: <span id="mcqScore">0%</span></p>
                    <p>Written Questions: <span style="color: var(--warning);">Pending Manual Review</span></p>
                </div>
                
                <p>Your results have been saved and will be reviewed by the administration.</p>
                <a href="#" class="btn" id="returnHome">Return to Homepage</a>
            </div>
        </div>
    </div>

    <!-- Admin Login Page -->
    <div id="adminLoginPage" class="page hidden">
        <header>
            <div class="container">
                <h1>EduQuiz - Admin Portal</h1>
                <p>Administrator Login</p>
            </div>
        </header>

        <div class="container">
            <div class="admin-login card">
                <h2>Admin Login</h2>
                <form id="adminLoginForm">
                    <div class="form-group">
                        <label for="adminUsername">Username</label>
                        <input type="text" id="adminUsername" required>
                    </div>
                    
                    <div class="form-group password-toggle">
                        <label for="adminPassword">Password</label>
                        <input type="password" id="adminPassword" required>
                        <button type="button" class="toggle-password" id="togglePassword">Show</button>
                    </div>
                    
                    <button type="submit" class="btn">Login</button>
                    <a href="#" class="btn btn-secondary" id="backToStudentPortal">Back to Student Portal</a>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="page hidden">
        <header>
            <div class="container">
                <h1>EduQuiz - Admin Dashboard</h1>
                <p>Submission Management and Grading</p>
            </div>
        </header>

        <div class="container">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Dashboard Overview</h2>
                    <button class="btn btn-danger" id="logoutBtn">Logout</button>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-label">Total Students</div>
                        <div class="stat-number" id="totalStudents">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Score</div>
                        <div class="stat-number" id="averageScore">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pending Reviews</div>
                        <div class="stat-number" id="pendingReviews">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Graded Submissions</div>
                        <div class="stat-number" id="gradedSubmissions">0</div>
                    </div>
                </div>
                
                <div class="faculty-breakdown">
                    <h3>Faculty Breakdown</h3>
                    <div id="facultyChart">
                        <!-- Faculty breakdown will be dynamically inserted here -->
                    </div>
                </div>
                
                <div class="recent-submissions">
                    <h3>Recent Submissions</h3>
                    <div id="recentSubmissionsTable">
                        <!-- Recent submissions table will be dynamically inserted here -->
                    </div>
                    <button class="btn" id="viewAllSubmissions">View All Submissions</button>
                    <button class="btn btn-success" id="exportDataBtn">Export Data</button>
                    <button class="btn btn-danger" id="clearAllDataBtn">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- All Submissions Page -->
    <div id="allSubmissionsPage" class="page hidden">
        <header>
            <div class="container">
                <h1>EduQuiz - All Submissions</h1>
                <p>View and manage all student submissions</p>
            </div>
        </header>

        <div class="container">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>All Student Submissions</h2>
                    <button class="btn btn-secondary" id="backToDashboard">Back to Dashboard</button>
                </div>
                
                <div class="search-filter">
                    <input type="text" id="searchSubmissions" placeholder="Search by name or student number">
                    <select id="filterByFaculty">
                        <option value="">All Faculties</option>
                        <option value="Education">Education</option>
                        <option value="Natural and Applied Science (NAS)">Natural and Applied Science (NAS)</option>
                        <option value="Humanities">Humanities</option>
                        <option value="Economic and Management Science (EMS)">Economic and Management Science (EMS)</option>
                    </select>
                    <select id="filterByStatus">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="graded">Graded</option>
                    </select>
                </div>
                
                <div id="submissionsTable">
                    <!-- Submissions table will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Student Grading Page -->
    <div id="gradingPage" class="page hidden">
        <header>
            <div class="container">
                <h1>EduQuiz - Student Grading</h1>
                <p>Grade written answers and calculate final scores</p>
            </div>
        </header>

        <div class="container">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Student Submission</h2>
                    <div>
                        <button class="btn btn-secondary" id="backToSubmissions">Back to Submissions</button>
                        <button class="btn" id="prevStudent">Previous Student</button>
                        <button class="btn" id="nextStudent">Next Student</button>
                    </div>
                </div>
                
                <div class="student-info">
                    <p><strong>Name:</strong> <span id="gradingStudentName"></span></p>
                    <p><strong>Student Number:</strong> <span id="gradingStudentNumber"></span></p>
                    <p><strong>Faculty:</strong> <span id="gradingFaculty"></span></p>
                    <p><strong>Submitted:</strong> <span id="submissionTime"></span></p>
                    <p><strong>Status:</strong> <span id="submissionStatus" class="status-badge status-pending">Pending</span></p>
                </div>
                
                <div class="grading-area">
                    <h3>Multiple Choice Questions (Auto-scored)</h3>
                    <div id="mcqAnswers">
                        <!-- MCQ answers will be dynamically inserted here -->
                    </div>
                    
                    <h3>Written Questions (Manual Grading)</h3>
                    <div id="writtenAnswers">
                        <!-- Written answers will be dynamically inserted here -->
                    </div>
                    
                    <div class="final-score">
                        Final Score: <span id="finalScoreDisplay">0%</span>
                    </div>
                    
                    <button class="btn btn-success" id="saveGradesBtn">Save Grades</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://kseylrlnmecgeixlnbvu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzZXlscmxubWVjZ2VpeGxuYnZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NTgzNDIsImV4cCI6MjA3NDEzNDM0Mn0.0q3n03k8Y_E-1kfx90OuVu6zeYB5QqJ7bnI2WahpcGE';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Quiz questions data
        const quizQuestions = [
            {
                id: 1,
                type: 'mcq',
                text: "I enjoy helping others overcome personal or academic challenges.",
                options: [
                    { text: "Not at all", points: 0 },
                    { text: "Rarely", points: 1 },
                    { text: "Sometimes", points: 2 },
                    { text: "Often", points: 3 },
                    { text: "Always", points: 4 }
                ],
                maxPoints: 4
            },
            {
                id: 2,
                type: 'mcq',
                text: "I am patient and empathetic when working with others.",
                options: [
                    { text: "Strongly disagree", points: 0 },
                    { text: "Disagree", points: 1 },
                    { text: "Neutral", points: 2 },
                    { text: "Agree", points: 3 },
                    { text: "Strongly agree", points: 4 }
                ],
                maxPoints: 4
            },
            {
                id: 3,
                type: 'mcq',
                text: "I am dependable and follow through on commitments.",
                options: [
                    { text: "Not dependable", points: 0 },
                    { text: "Sometimes dependable", points: 1 },
                    { text: "Usually dependable", points: 2 },
                    { text: "Dependable most of the time", points: 3 },
                    { text: "Always dependable", points: 4 }
                ],
                maxPoints: 4
            },
            {
                id: 4,
                type: 'mcq',
                text: "I value diversity and respect different perspectives.",
                options: [
                    { text: "Never", points: 0 },
                    { text: "Rarely", points: 1 },
                    { text: "Sometimes", points: 2 },
                    { text: "Often", points: 3 },
                    { text: "Always", points: 4 }
                ],
                maxPoints: 4
            },
            {
                id: 5,
                type: 'mcq',
                text: "I am motivated to make a positive impact in my community.",
                options: [
                    { text: "Not motivated", points: 0 },
                    { text: "Slightly motivated", points: 1 },
                    { text: "Moderately motivated", points: 2 },
                    { text: "Very motivated", points: 3 },
                    { text: "Extremely motivated", points: 4 }
                ],
                maxPoints: 4
            },
            {
                id: 6,
                type: 'mcq',
                text: "Scenario: A mentee stops attending sessions and doesn't respond to messages. What do you do?",
                options: [
                    { text: "Report them immediately to a supervisor", points: 0 },
                    { text: "Reach out with a supportive message and offer to talk", points: 5 },
                    { text: "Ignore the situation and wait for them to return", points: 0 },
                    { text: "Remove them from your mentee list", points: 0 }
                ],
                maxPoints: 5
            },
            {
                id: 7,
                type: 'mcq',
                text: "Scenario: A mentee shares a personal issue that you're not trained to handle. What's your response?",
                options: [
                    { text: "Give them advice based on your own experience", points: 0 },
                    { text: "Listen supportively and refer them to appropriate resources", points: 5 },
                    { text: "Change the subject to avoid discomfort", points: 0 },
                    { text: "Tell them you can't help with personal issues", points: 0 }
                ],
                maxPoints: 5
            },
            {
                id: 8,
                type: 'written',
                text: "How would you support a mentee who is struggling academically? (Maximum 150 words)",
                maxPoints: 5
            },
            {
                id: 9,
                type: 'written',
                text: "Describe a time you helped someone through a difficult situation. (Maximum 200 words)",
                maxPoints: 5
            },
            {
                id: 10,
                type: 'written',
                text: "What strategies would you use to build trust with a mentee? (Maximum 150 words)",
                maxPoints: 5
            },
            {
                id: 11,
                type: 'mcq',
                text: "How many hours per week can you commit to mentoring?",
                options: [
                    { text: "Less than 2 hours", points: 0 },
                    { text: "2–4 hours", points: 0 },
                    { text: "5–7 hours", points: 3 },
                    { text: "More than 7 hours", points: 0 }
                ],
                maxPoints: 3
            },
            {
                id: 12,
                type: 'mcq',
                text: "Are you available for training and regular check-ins?",
                options: [
                    { text: "No, not available", points: 0 },
                    { text: "Available occasionally", points: 0 },
                    { text: "Available most times", points: 0 },
                    { text: "Always available", points: 2 }
                ],
                maxPoints: 2
            }
        ];

        // Global variables
        let currentStudent = null;
        let currentSubmission = null;
        let currentQuestionIndex = 0;
        let studentAnswers = {};
        let quizTimer = null;
        let timeLeft = 45 * 60; // 45 minutes in seconds
        let allSubmissions = [];
        let currentGradingIndex = 0;

        // DOM Elements
        const pages = {
            studentHomepage: document.getElementById('studentHomepage'),
            quizPage: document.getElementById('quizPage'),
            successPage: document.getElementById('successPage'),
            adminLoginPage: document.getElementById('adminLoginPage'),
            adminDashboard: document.getElementById('adminDashboard'),
            allSubmissionsPage: document.getElementById('allSubmissionsPage'),
            gradingPage: document.getElementById('gradingPage')
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            checkIfStudentAlreadySubmitted();
        });

        // Set up all event listeners
        function initializeEventListeners() {
            // Student registration
            document.getElementById('registrationForm').addEventListener('submit', handleStudentRegistration);
            document.getElementById('adminAccessBtn').addEventListener('click', showAdminLogin);
            
            // Quiz navigation
            document.getElementById('prevQuestion').addEventListener('click', showPreviousQuestion);
            document.getElementById('nextQuestion').addEventListener('click', showNextQuestion);
            document.getElementById('submitQuiz').addEventListener('click', submitQuiz);
            
            // Success page
            document.getElementById('returnHome').addEventListener('click', returnToHomepage);
            
            // Admin login
            document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
            document.getElementById('togglePassword').addEventListener('click', togglePasswordVisibility);
            document.getElementById('backToStudentPortal').addEventListener('click', showStudentHomepage);
            
            // Admin dashboard
            document.getElementById('logoutBtn').addEventListener('click', handleAdminLogout);
            document.getElementById('viewAllSubmissions').addEventListener('click', showAllSubmissions);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('clearAllDataBtn').addEventListener('click', clearAllData);
            
            // All submissions page
            document.getElementById('backToDashboard').addEventListener('click', showAdminDashboard);
            document.getElementById('searchSubmissions').addEventListener('input', filterSubmissions);
            document.getElementById('filterByFaculty').addEventListener('change', filterSubmissions);
            document.getElementById('filterByStatus').addEventListener('change', filterSubmissions);
            
            // Grading page
            document.getElementById('backToSubmissions').addEventListener('click', showAllSubmissions);
            document.getElementById('prevStudent').addEventListener('click', showPreviousStudent);
            document.getElementById('nextStudent').addEventListener('click', showNextStudent);
            document.getElementById('saveGradesBtn').addEventListener('click', saveGrades);
        }

        // Page navigation functions
        function showPage(pageName) {
            // Hide all pages
            Object.values(pages).forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show the requested page
            pages[pageName].classList.remove('hidden');
        }

        function showStudentHomepage() {
            showPage('studentHomepage');
        }

        function showQuizPage() {
            showPage('quizPage');
            initializeQuiz();
        }

        function showSuccessPage() {
            showPage('successPage');
            triggerConfetti();
            displayQuizResults();
        }

        function showAdminLogin() {
            showPage('adminLoginPage');
        }

        function showAdminDashboard() {
            showPage('adminDashboard');
            loadDashboardData();
        }

        function showAllSubmissions() {
            showPage('allSubmissionsPage');
            loadAllSubmissions();
        }

        function showGradingPage(submissionId) {
            showPage('gradingPage');
            loadStudentSubmission(submissionId);
        }

        // Student registration
        async function handleStudentRegistration(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const studentNumber = document.getElementById('studentNumber').value;
            const faculty = document.getElementById('faculty').value;
            
            // Check if student already exists
            const { data: existingStudent, error } = await supabase
                .from('students')
                .select('*')
                .eq('student_number', studentNumber)
                .single();
            
            if (existingStudent) {
                // Check if student already has a submission
                const { data: existingSubmission } = await supabase
                    .from('submissions')
                    .select('*')
                    .eq('student_id', existingStudent.id)
                    .single();
                
                if (existingSubmission) {
                    alert('This student number has already taken the quiz. Only one attempt is allowed.');
                    return;
                }
                
                // Student exists but hasn't taken the quiz
                currentStudent = existingStudent;
            } else {
                // Create new student
                const { data: newStudent, error } = await supabase
                    .from('students')
                    .insert([
                        { 
                            full_name: fullName, 
                            student_number: studentNumber, 
                            faculty: faculty 
                        }
                    ])
                    .select()
                    .single();
                
                if (error) {
                    console.error('Error creating student:', error);
                    alert('Error registering student. Please try again.');
                    return;
                }
                
                currentStudent = newStudent;
            }
            
            // Initialize student answers
            studentAnswers = {};
            
            // Show quiz page
            showQuizPage();
        }

        // Check if student already submitted (for page reload scenarios)
        async function checkIfStudentAlreadySubmitted() {
            // This would typically check localStorage or session for a student ID
            // For now, we'll rely on the database check during registration
        }

        // Quiz initialization
        function initializeQuiz() {
            // Display student info
            document.getElementById('quizStudentName').textContent = currentStudent.full_name;
            document.getElementById('quizFaculty').textContent = currentStudent.faculty;
            
            // Initialize questions
            renderQuestions();
            
            // Start timer
            startTimer();
            
            // Show first question
            showQuestion(0);
        }

        // Render all questions
        function renderQuestions() {
            const container = document.getElementById('questionContainer');
            container.innerHTML = '';
            
            quizQuestions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = `question-card ${index === 0 ? 'active' : ''}`;
                questionCard.id = `question-${index}`;
                
                let questionHTML = `
                    <div class="question-text">${question.id}. ${question.text}</div>
                    <div class="question-number">Question ${question.id} of 12</div>
                `;
                
                if (question.type === 'mcq') {
                    questionHTML += '<div class="options">';
                    question.options.forEach((option, optIndex) => {
                        questionHTML += `
                            <div class="option" data-question="${index}" data-option="${optIndex}">
                                ${option.text}
                            </div>
                        `;
                    });
                    questionHTML += '</div>';
                } else {
                    questionHTML += `
                        <textarea class="written-answer" data-question="${index}" placeholder="Type your answer here..." rows="5"></textarea>
                        <div class="word-limit">Maximum ${question.id === 9 ? '200' : '150'} words</div>
                    `;
                }
                
                questionCard.innerHTML = questionHTML;
                container.appendChild(questionCard);
            });
            
            // Add event listeners to MCQ options
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    const questionIndex = parseInt(this.getAttribute('data-question'));
                    const optionIndex = parseInt(this.getAttribute('data-option'));
                    
                    // Deselect all options for this question
                    document.querySelectorAll(`.option[data-question="${questionIndex}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Select this option
                    this.classList.add('selected');
                    
                    // Save answer
                    studentAnswers[questionIndex] = {
                        type: 'mcq',
                        answer: optionIndex,
                        points: quizQuestions[questionIndex].options[optionIndex].points
                    };
                    
                    // Auto-save to database
                    autoSaveAnswers();
                });
            });
            
            // Add event listeners to written answers
            document.querySelectorAll('.written-answer').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    const questionIndex = parseInt(this.getAttribute('data-question'));
                    
                    // Save answer
                    studentAnswers[questionIndex] = {
                        type: 'written',
                        answer: this.value,
                        points: 0 // Will be set during grading
                    };
                    
                    // Auto-save to database
                    autoSaveAnswers();
                });
            });
        }

        // Auto-save answers to database
        async function autoSaveAnswers() {
            if (!currentStudent) return;
            
            // Check if submission already exists
            let submissionId = null;
            const { data: existingSubmission } = await supabase
                .from('submissions')
                .select('id')
                .eq('student_id', currentStudent.id)
                .single();
            
            if (existingSubmission) {
                submissionId = existingSubmission.id;
                
                // Update existing submission
                await supabase
                    .from('submissions')
                    .update({ 
                        answers: studentAnswers,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', submissionId);
            } else {
                // Create new submission
                const { data: newSubmission, error } = await supabase
                    .from('submissions')
                    .insert([
                        { 
                            student_id: currentStudent.id,
                            answers: studentAnswers,
                            status: 'in_progress'
                        }
                    ])
                    .select()
                    .single();
                
                if (error) {
                    console.error('Error saving answers:', error);
                    return;
                }
                
                submissionId = newSubmission.id;
            }
        }

        // Show specific question
        function showQuestion(index) {
            // Hide all questions
            document.querySelectorAll('.question-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Show selected question
            document.getElementById(`question-${index}`).classList.add('active');
            
            // Update navigation buttons
            document.getElementById('prevQuestion').style.display = index === 0 ? 'none' : 'inline-block';
            document.getElementById('nextQuestion').style.display = index === quizQuestions.length - 1 ? 'none' : 'inline-block';
            document.getElementById('submitQuiz').style.display = index === quizQuestions.length - 1 ? 'inline-block' : 'none';
            
            // Update progress bar
            const progress = ((index + 1) / quizQuestions.length) * 100;
            document.getElementById('quizProgress').style.width = `${progress}%`;
            
            // Pre-fill existing answers
            if (studentAnswers[index]) {
                if (studentAnswers[index].type === 'mcq') {
                    const options = document.querySelectorAll(`.option[data-question="${index}"]`);
                    if (options.length > 0) {
                        options[studentAnswers[index].answer].classList.add('selected');
                    }
                } else {
                    const textarea = document.querySelector(`.written-answer[data-question="${index}"]`);
                    if (textarea) {
                        textarea.value = studentAnswers[index].answer;
                    }
                }
            }
        }

        // Navigation between questions
        function showPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
            }
        }

        function showNextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            }
        }

        // Quiz timer
        function startTimer() {
            updateTimerDisplay();
            
            quizTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    submitQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timerElement = document.getElementById('quizTimer');
            
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color when time is running low
            if (timeLeft <= 300) { // 5 minutes
                timerElement.classList.add('danger');
            } else if (timeLeft <= 600) { // 10 minutes
                timerElement.classList.add('warning');
            }
        }

        // Submit quiz
        async function submitQuiz() {
            clearInterval(quizTimer);
            
            // Calculate automatic score for MCQ questions
            let mcqScore = 0;
            let totalMcqPoints = 0;
            
            quizQuestions.forEach((question, index) => {
                if (question.type === 'mcq' && studentAnswers[index]) {
                    mcqScore += studentAnswers[index].points;
                    totalMcqPoints += question.maxPoints;
                }
            });
            
            const autoScore = totalMcqPoints > 0 ? (mcqScore / totalMcqPoints) * 100 : 0;
            
            // Save submission to database
            const { data: submission, error } = await supabase
                .from('submissions')
                .update({
                    answers: studentAnswers,
                    auto_score: autoScore,
                    total_mcq: totalMcqPoints,
                    submitted_at: new Date().toISOString(),
                    status: 'pending',
                    updated_at: new Date().toISOString()
                })
                .eq('student_id', currentStudent.id)
                .select()
                .single();
            
            if (error) {
                console.error('Error submitting quiz:', error);
                alert('Error submitting quiz. Please try again.');
                return;
            }
            
            currentSubmission = submission;
            showSuccessPage();
        }

        // Display quiz results on success page
        function displayQuizResults() {
            if (currentSubmission) {
                document.getElementById('mcqScore').textContent = `${Math.round(currentSubmission.auto_score)}%`;
            }
        }

        // Confetti animation
        function triggerConfetti() {
            const confettiContainer = document.getElementById('confettiContainer');
            
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            setTimeout(() => {
                confetti({
                    particleCount: 100,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 }
                });
            }, 250);
            
            setTimeout(() => {
                confetti({
                    particleCount: 100,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 }
                });
            }, 400);
        }

        // Return to homepage
        function returnToHomepage() {
            // Reset quiz state
            currentStudent = null;
            currentSubmission = null;
            currentQuestionIndex = 0;
            studentAnswers = {};
            timeLeft = 45 * 60;
            
            // Reset form
            document.getElementById('registrationForm').reset();
            
            showStudentHomepage();
        }

        // Admin login
        async function handleAdminLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            // Check admin credentials (in a real app, this would be verified against the database)
            if (username === 'Spu@DSA' && password === '#Spu@2026') {
                showAdminDashboard();
            } else {
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = 'Invalid username or password. Please try again.';
                
                const form = document.getElementById('adminLoginForm');
                form.insertBefore(errorDiv, form.firstChild);
                
                // Remove error message after 3 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 3000);
            }
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('adminPassword');
            const toggleButton = document.getElementById('togglePassword');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.textContent = 'Hide';
            } else {
                passwordInput.type = 'password';
                toggleButton.textContent = 'Show';
            }
        }

        // Admin logout
        function handleAdminLogout() {
            showStudentHomepage();
        }

        // Load dashboard data
        async function loadDashboardData() {
            // Fetch all submissions with student data
            const { data: submissions, error } = await supabase
                .from('submissions')
                .select(`
                    *,
                    students (
                        full_name,
                        student_number,
                        faculty
                    )
                `)
                .order('submitted_at', { ascending: false });
            
            if (error) {
                console.error('Error fetching submissions:', error);
                return;
            }
            
            allSubmissions = submissions || [];
            
            // Calculate statistics
            const totalStudents = allSubmissions.length;
            const pendingReviews = allSubmissions.filter(s => s.status === 'pending').length;
            const gradedSubmissions = allSubmissions.filter(s => s.status === 'graded').length;
            
            // Calculate average score (only for graded submissions)
            const gradedScores = allSubmissions
                .filter(s => s.status === 'graded' && s.final_score !== null)
                .map(s => s.final_score);
            
            const averageScore = gradedScores.length > 0 
                ? gradedScores.reduce((a, b) => a + b, 0) / gradedScores.length 
                : 0;
            
            // Faculty breakdown
            const facultyCounts = {};
            allSubmissions.forEach(submission => {
                const faculty = submission.students.faculty;
                facultyCounts[faculty] = (facultyCounts[faculty] || 0) + 1;
            });
            
            // Update dashboard UI
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('averageScore').textContent = `${Math.round(averageScore)}%`;
            document.getElementById('pendingReviews').textContent = pendingReviews;
            document.getElementById('gradedSubmissions').textContent = gradedSubmissions;
            
            // Update faculty chart
            const facultyChart = document.getElementById('facultyChart');
            facultyChart.innerHTML = '';
            
            for (const [faculty, count] of Object.entries(facultyCounts)) {
                const percentage = (count / totalStudents) * 100;
                const facultyDiv = document.createElement('div');
                facultyDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${faculty}</span>
                        <span>${count} (${Math.round(percentage)}%)</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${percentage}%"></div>
                    </div>
                `;
                facultyChart.appendChild(facultyDiv);
            }
            
            // Update recent submissions table
            const recentSubmissionsTable = document.getElementById('recentSubmissionsTable');
            recentSubmissionsTable.innerHTML = '';
            
            const recentSubmissions = allSubmissions.slice(0, 5); // Show only 5 most recent
            
            if (recentSubmissions.length === 0) {
                recentSubmissionsTable.innerHTML = '<p>No submissions yet.</p>';
                return;
            }
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Faculty</th>
                            <th>Score</th>
                            <th>Status</th>
                            <th>Submitted</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recentSubmissions.forEach(submission => {
                const student = submission.students;
                const score = submission.status === 'graded' 
                    ? `${Math.round(submission.final_score)}%` 
                    : `${Math.round(submission.auto_score)}% (Auto)`;
                
                const statusClass = submission.status === 'graded' ? 'status-graded' : 'status-pending';
                const statusText = submission.status === 'graded' ? 'Graded' : 'Pending';
                
                const submittedDate = new Date(submission.submitted_at).toLocaleDateString();
                
                tableHTML += `
                    <tr>
                        <td>${student.full_name}</td>
                        <td>${student.faculty}</td>
                        <td>${score}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${submittedDate}</td>
                        <td><button class="btn btn-small view-submission" data-id="${submission.id}">View</button></td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            recentSubmissionsTable.innerHTML = tableHTML;
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-submission').forEach(button => {
                button.addEventListener('click', function() {
                    const submissionId = this.getAttribute('data-id');
                    showGradingPage(submissionId);
                });
            });
        }

        // Load all submissions for the submissions page
        async function loadAllSubmissions() {
            const submissionsTable = document.getElementById('submissionsTable');
            submissionsTable.innerHTML = '<p>Loading submissions...</p>';
            
            // Fetch all submissions with student data
            const { data: submissions, error } = await supabase
                .from('submissions')
                .select(`
                    *,
                    students (
                        full_name,
                        student_number,
                        faculty
                    )
                `)
                .order('submitted_at', { ascending: false });
            
            if (error) {
                console.error('Error fetching submissions:', error);
                submissionsTable.innerHTML = '<p>Error loading submissions. Please try again.</p>';
                return;
            }
            
            allSubmissions = submissions || [];
            renderSubmissionsTable(allSubmissions);
        }

        // Render submissions table with filtering
        function renderSubmissionsTable(submissions) {
            const submissionsTable = document.getElementById('submissionsTable');
            
            if (submissions.length === 0) {
                submissionsTable.innerHTML = '<p>No submissions found.</p>';
                return;
            }
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Student Number</th>
                            <th>Faculty</th>
                            <th>Auto Score</th>
                            <th>Final Score</th>
                            <th>Status</th>
                            <th>Submitted</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            submissions.forEach(submission => {
                const student = submission.students;
                const autoScore = submission.auto_score ? `${Math.round(submission.auto_score)}%` : 'N/A';
                const finalScore = submission.final_score ? `${Math.round(submission.final_score)}%` : 'N/A';
                
                const statusClass = submission.status === 'graded' ? 'status-graded' : 'status-pending';
                const statusText = submission.status === 'graded' ? 'Graded' : 'Pending';
                
                const submittedDate = new Date(submission.submitted_at).toLocaleDateString();
                
                tableHTML += `
                    <tr>
                        <td>${student.full_name}</td>
                        <td>${student.student_number}</td>
                        <td>${student.faculty}</td>
                        <td>${autoScore}</td>
                        <td>${finalScore}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${submittedDate}</td>
                        <td><button class="btn btn-small view-submission" data-id="${submission.id}">Grade</button></td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            submissionsTable.innerHTML = tableHTML;
            
            // Add event listeners to grade buttons
            document.querySelectorAll('.view-submission').forEach(button => {
                button.addEventListener('click', function() {
                    const submissionId = this.getAttribute('data-id');
                    showGradingPage(submissionId);
                });
            });
        }

        // Filter submissions based on search and filter criteria
        function filterSubmissions() {
            const searchTerm = document.getElementById('searchSubmissions').value.toLowerCase();
            const facultyFilter = document.getElementById('filterByFaculty').value;
            const statusFilter = document.getElementById('filterByStatus').value;
            
            const filteredSubmissions = allSubmissions.filter(submission => {
                const student = submission.students;
                
                // Search filter
                const matchesSearch = searchTerm === '' || 
                    student.full_name.toLowerCase().includes(searchTerm) ||
                    student.student_number.toLowerCase().includes(searchTerm);
                
                // Faculty filter
                const matchesFaculty = facultyFilter === '' || student.faculty === facultyFilter;
                
                // Status filter
                const matchesStatus = statusFilter === '' || submission.status === statusFilter;
                
                return matchesSearch && matchesFaculty && matchesStatus;
            });
            
            renderSubmissionsTable(filteredSubmissions);
        }

        // Load individual student submission for grading
        async function loadStudentSubmission(submissionId) {
            // Find the submission in our allSubmissions array
            const submissionIndex = allSubmissions.findIndex(s => s.id == submissionId);
            if (submissionIndex === -1) return;
            
            currentGradingIndex = submissionIndex;
            currentSubmission = allSubmissions[submissionIndex];
            
            const student = currentSubmission.students;
            
            // Display student info
            document.getElementById('gradingStudentName').textContent = student.full_name;
            document.getElementById('gradingStudentNumber').textContent = student.student_number;
            document.getElementById('gradingFaculty').textContent = student.faculty;
            document.getElementById('submissionTime').textContent = new Date(currentSubmission.submitted_at).toLocaleString();
            
            const statusElement = document.getElementById('submissionStatus');
            statusElement.textContent = currentSubmission.status === 'graded' ? 'Graded' : 'Pending';
            statusElement.className = `status-badge ${currentSubmission.status === 'graded' ? 'status-graded' : 'status-pending'}`;
            
            // Display MCQ answers
            const mcqAnswersContainer = document.getElementById('mcqAnswers');
            mcqAnswersContainer.innerHTML = '';
            
            quizQuestions.forEach((question, index) => {
                if (question.type !== 'mcq') return;
                
                if (currentSubmission.answers && currentSubmission.answers[index]) {
                    const answer = currentSubmission.answers[index];
                    const optionText = question.options[answer.answer].text;
                    const points = answer.points;
                    
                    const answerDiv = document.createElement('div');
                    answerDiv.className = 'written-answer';
                    answerDiv.innerHTML = `
                        <p><strong>${question.id}. ${question.text}</strong></p>
                        <p>Answer: ${optionText}</p>
                        <p>Points: ${points} / ${question.maxPoints}</p>
                    `;
                    
                    mcqAnswersContainer.appendChild(answerDiv);
                }
            });
            
            // Display written answers for grading
            const writtenAnswersContainer = document.getElementById('writtenAnswers');
            writtenAnswersContainer.innerHTML = '';
            
            // Initialize manual scores if not exists
            if (!currentSubmission.manual_scores) {
                currentSubmission.manual_scores = {};
            }
            
            quizQuestions.forEach((question, index) => {
                if (question.type !== 'written') return;
                
                if (currentSubmission.answers && currentSubmission.answers[index]) {
                    const answer = currentSubmission.answers[index].answer || '';
                    const currentScore = currentSubmission.manual_scores[index] || 0;
                    
                    const answerDiv = document.createElement('div');
                    answerDiv.className = 'grading-area';
                    answerDiv.innerHTML = `
                        <p><strong>${question.id}. ${question.text}</strong> (Max: ${question.maxPoints} points)</p>
                        <div class="written-answer">
                            <p>${answer}</p>
                        </div>
                        <div class="form-group">
                            <label for="score-${index}">Score (0-${question.maxPoints}):</label>
                            <input type="number" id="score-${index}" class="score-input" min="0" max="${question.maxPoints}" value="${currentScore}">
                        </div>
                    `;
                    
                    writtenAnswersContainer.appendChild(answerDiv);
                    
                    // Add event listener to update final score when score changes
                    document.getElementById(`score-${index}`).addEventListener('input', updateFinalScore);
                }
            });
            
            // Calculate and display final score
            updateFinalScore();
            
            // Update navigation buttons
            document.getElementById('prevStudent').disabled = currentGradingIndex === 0;
            document.getElementById('nextStudent').disabled = currentGradingIndex === allSubmissions.length - 1;
        }

        // Update final score display
        function updateFinalScore() {
            if (!currentSubmission) return;
            
            let totalPoints = 0;
            let maxPossiblePoints = 0;
            
            // Calculate MCQ points
            quizQuestions.forEach((question, index) => {
                if (question.type === 'mcq' && currentSubmission.answers && currentSubmission.answers[index]) {
                    totalPoints += currentSubmission.answers[index].points;
                    maxPossiblePoints += question.maxPoints;
                }
            });
            
            // Calculate written points
            quizQuestions.forEach((question, index) => {
                if (question.type === 'written') {
                    const scoreInput = document.getElementById(`score-${index}`);
                    if (scoreInput) {
                        const score = parseInt(scoreInput.value) || 0;
                        totalPoints += score;
                        maxPossiblePoints += question.maxPoints;
                    }
                }
            });
            
            const finalScore = maxPossiblePoints > 0 ? (totalPoints / maxPossiblePoints) * 100 : 0;
            document.getElementById('finalScoreDisplay').textContent = `${Math.round(finalScore)}%`;
        }

        // Navigate between students for grading
        function showPreviousStudent() {
            if (currentGradingIndex > 0) {
                currentGradingIndex--;
                loadStudentSubmission(allSubmissions[currentGradingIndex].id);
            }
        }

        function showNextStudent() {
            if (currentGradingIndex < allSubmissions.length - 1) {
                currentGradingIndex++;
                loadStudentSubmission(allSubmissions[currentGradingIndex].id);
            }
        }

        // Save grades to database
        async function saveGrades() {
            if (!currentSubmission) return;
            
            // Collect manual scores
            const manualScores = {};
            quizQuestions.forEach((question, index) => {
                if (question.type === 'written') {
                    const scoreInput = document.getElementById(`score-${index}`);
                    if (scoreInput) {
                        manualScores[index] = parseInt(scoreInput.value) || 0;
                    }
                }
            });
            
            // Calculate final score
            let totalPoints = 0;
            let maxPossiblePoints = 0;
            
            // MCQ points
            quizQuestions.forEach((question, index) => {
                if (question.type === 'mcq' && currentSubmission.answers && currentSubmission.answers[index]) {
                    totalPoints += currentSubmission.answers[index].points;
                    maxPossiblePoints += question.maxPoints;
                }
            });
            
            // Written points
            Object.values(manualScores).forEach(score => {
                totalPoints += score;
            });
            
            // Written max points
            quizQuestions.forEach(question => {
                if (question.type === 'written') {
                    maxPossiblePoints += question.maxPoints;
                }
            });
            
            const finalScore = maxPossiblePoints > 0 ? (totalPoints / maxPossiblePoints) * 100 : 0;
            
            // Update submission in database
            const { error } = await supabase
                .from('submissions')
                .update({
                    manual_scores: manualScores,
                    final_score: finalScore,
                    status: 'graded',
                    updated_at: new Date().toISOString()
                })
                .eq('id', currentSubmission.id);
            
            if (error) {
                console.error('Error saving grades:', error);
                alert('Error saving grades. Please try again.');
                return;
            }
            
            // Update local data
            currentSubmission.manual_scores = manualScores;
            currentSubmission.final_score = finalScore;
            currentSubmission.status = 'graded';
            
            // Update status display
            const statusElement = document.getElementById('submissionStatus');
            statusElement.textContent = 'Graded';
            statusElement.className = 'status-badge status-graded';
            
            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = 'Grades saved successfully!';
            
            const gradingArea = document.querySelector('.grading-area');
            gradingArea.insertBefore(successDiv, gradingArea.firstChild);
            
            // Remove success message after 3 seconds
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
            
            // Refresh dashboard data if we're coming from there
            if (pages.adminDashboard.classList.contains('hidden') === false) {
                loadDashboardData();
            }
        }

        // Export data to CSV
        async function exportData() {
            // Fetch all submissions with student data
            const { data: submissions, error } = await supabase
                .from('submissions')
                .select(`
                    *,
                    students (
                        full_name,
                        student_number,
                        faculty
                    )
                `)
                .order('submitted_at', { ascending: false });
            
            if (error) {
                console.error('Error fetching submissions for export:', error);
                alert('Error exporting data. Please try again.');
                return;
            }
            
            // Create CSV content
            let csvContent = 'Name,Student Number,Faculty,Auto Score,Final Score,Status,Submitted At\n';
            
            submissions.forEach(submission => {
                const student = submission.students;
                const autoScore = submission.auto_score ? Math.round(submission.auto_score) : 'N/A';
                const finalScore = submission.final_score ? Math.round(submission.final_score) : 'N/A';
                const status = submission.status;
                const submittedAt = new Date(submission.submitted_at).toLocaleString();
                
                csvContent += `"${student.full_name}","${student.student_number}","${student.faculty}",${autoScore},${finalScore},${status},"${submittedAt}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eduquiz-submissions-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Clear all data (with confirmation)
        async function clearAllData() {
            const confirmed = confirm('Are you sure you want to clear all data? This action cannot be undone.');
            
            if (!confirmed) return;
            
            // Delete all submissions
            const { error: submissionsError } = await supabase
                .from('submissions')
                .delete()
                .neq('id', 0); // Delete all records
                
            // Delete all students
            const { error: studentsError } = await supabase
                .from('students')
                .delete()
                .neq('id', 0); // Delete all records
            
            if (submissionsError || studentsError) {
                console.error('Error clearing data:', submissionsError || studentsError);
                alert('Error clearing data. Please try again.');
                return;
            }
            
            alert('All data has been cleared successfully.');
            loadDashboardData();
        }
    </script>
</body>
</html>